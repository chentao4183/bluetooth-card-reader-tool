# 蓝牙刷卡器工具 - 产品需求文档（PRD）

## 需求描述

### 背景
- **业务问题**：医院内窥镜洗消流程需要将蓝牙刷卡器读取的卡号、屏幕 OCR 识别的患者信息与后端系统（V1.0/V2.0）进行验证和绑定，实现洗消记录的自动化追溯。
- **目标用户**：医院洗消中心操作人员、医护人员
- **价值主张**：
  - 自动化数据采集，减少手工录入错误
  - 支持多种蓝牙设备模式（BLE GATT / HID 键盘）
  - 灵活对接新旧系统接口（V1.0/V2.0）
  - 离线环境可用，保障内网安全

### 功能概览
- **核心功能**：
  1. BLE 蓝牙设备扫描、连接、通知订阅
  2. HID 键盘模式监听（Raw Input）
  3. 屏幕 OCR 识别（EasyOCR 离线方案）
  4. 洗消验证接口调用（V1.0/V2.0 可选）
  5. 信息绑定接口调用
  6. 配置持久化（JSON 文件）
  7. 开机自启动、浮球手动输入、自动提交等后台功能

- **功能边界**：
  - ✅ 支持：BLE 和 HID 键盘两种蓝牙模式
  - ✅ 支持：Windows 10+ 平台
  - ✅ 支持：离线 OCR 识别（EasyOCR）
  - ❌ 不支持：经典蓝牙（非 BLE）
  - ❌ 不支持：macOS/Linux 平台
  - ❌ 不支持：在线 OCR API

- **用户场景**：
  1. **场景 1 - BLE 模式刷卡**：插入蓝牙刷卡器 → 扫描并连接 → 刷卡读取卡号 → 自动触发验证和绑定流程
  2. **场景 2 - HID 键盘模式**：配对 HID 键盘设备 → 后台监听键盘输入 → 接收 10 位卡号 → 触发验证和绑定
  3. **场景 3 - 浮球手动输入**：蓝牙设备异常时 → 点击屏幕浮球 → 手动输入卡号 → 继续 OCR 和绑定流程
  4. **场景 4 - OCR 字段配置**：新增/编辑识别字段 → 定位屏幕区域 → 测试识别 → 保存配置

### 详细需求

#### 1. 蓝牙配置页
- **输入/输出**：
  - 输入：用户点击"扫描"按钮
  - 输出：设备列表（设备名称、MAC 地址、状态）
- **用户交互**：
  - 扫描 → 选择设备 → 连接 → 自动订阅通知 → 日志显示接收数据
  - 支持断开连接操作
  - 显示当前已连接设备信息（设备名 + MAC）
- **数据要求**：
  - BLE 设备：通过 `bleak` 库扫描，获取设备名、地址、RSSI
  - HID 设备：通过 Windows 设备枚举接口获取已配对设备
  - 卡号格式：10 位数字字符串
- **边界情况**：
  - 扫描超时（30 秒）无设备：提示"未发现设备"
  - 连接失败：自动重连 3 次（间隔 10 秒），失败后提示用户
  - 监听中断开：弹窗提示"蓝牙刷卡器已掉线，请检查后重新连接"
  - HID 卡号长度异常（非 10 位）：丢弃数据，不处理

#### 2. OCR 配置页
- **输入/输出**：
  - 输入：用户新增字段、定位屏幕区域、点击"识别"按钮
  - 输出：识别结果（文本）、识别示例显示
- **用户交互**：
  - 新增字段 → 填写名称/参数名 → 定位屏幕区域（x, y, width, height）→ 测试识别 → 保存
  - 支持启用/禁用字段、删除字段
  - 支持填写默认值（分号分隔多选项）
  - 识别完成后弹窗显示所有字段，允许手动修正
- **数据要求**：
  - OCR 引擎：**PaddleOCR**（离线方案，C# 封装）
  - 识别区域：坐标 (x, y) + 尺寸 (width, height)
  - 字段类型：文本、数字、日期等
  - 默认值：静态配置，用于 OCR 缺失时回退
- **边界情况**：
  - 识别结果为空：弹窗显示空值，允许手动输入
  - 识别乱码：弹窗显示原始结果，用户可修正
  - 未配置识别区域：提示"请先定位屏幕区域"

#### 3. 服务配置页
- **输入/输出**：
  - 输入：选择系统版本（V1.0/V2.0）、填写接口 URL、开启/关闭验证功能
  - 输出：保存到 `app_settings.json`
- **用户交互**：
  - 切换系统版本 → 填写验证接口 URL 和绑定接口 URL → 保存
  - 勾选"开启洗消验证"、"弹窗显示结果"
- **数据要求**：
  - V1.0 和 V2.0 各维护两个 URL（验证 + 绑定）
  - 接口规范见下文"接口设计"章节
- **边界情况**：
  - URL 格式错误：保存时提示"请输入有效的 URL"
  - 接口不可达：调用时提示"网络异常，请检查接口地址"

#### 4. 后台配置页
- **输入/输出**：
  - 输入：选择手动/自动提交、设置倒计时、勾选开机自启动/浮球输入/开启服务
  - 输出：保存到 `app_settings.json` 和 Windows 注册表（自启动）
- **用户交互**：
  - 选择提交模式 → 设置倒计时（1-30 秒）→ 勾选后台功能 → 保存
- **数据要求**：
  - 提交模式：手动 / 自动（带倒计时）
  - 开机自启动：写入 Windows 注册表 `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run`
  - 浮球输入：屏幕悬浮窗，支持拖拽和点击输入
- **边界情况**：
  - 自动提交倒计时为 0：视为手动模式
  - 注册表写入失败：提示"需要管理员权限"

#### 5. HID 键盘监听
- **输入/输出**：
  - 输入：HID 设备关键字（如 `RFID;CARD`）、卡号长度（默认 10 位）、是否需要 Enter 结束
  - 输出：10 位卡号字符串
- **用户交互**：
  - 配置 HID 监听参数 → 扫描设备 → 选择目标设备 → 连接 → 后台监听键盘输入
- **数据要求**：
  - 使用 Windows Raw Input API 监听指定设备
  - 过滤其他键盘输入，仅处理目标设备
  - 卡号长度校验：必须为 10 位数字
- **边界情况**：
  - 设备未配对：提示"请先在 Windows 设置中添加设备"
  - 设备拔出：弹窗提示"蓝牙刷卡器已掉线，请检查后重新连接"
  - 接收非 10 位数据：丢弃，不处理

---

## 设计决策

### 技术方案

#### 架构选择
- **技术栈**：
  - 语言：**C# (.NET 6)**
  - GUI 框架：**WinForms**（轻量级）或 **WPF**（现代化界面）
  - 蓝牙库：`InTheHand.BluetoothLE`（支持 BLE GATT）+ Windows Raw Input API（HID 键盘）
  - OCR 引擎：**PaddleOCR-Sharp**（离线、准确率高、支持中文）
  - HTTP 请求：`HttpClient`（.NET 内置）
  - 配置存储：`System.Text.Json`（JSON 序列化）
  - 打包方式：**.NET 6 Self-contained**（单文件 EXE，免安装）

- **架构决策理由**：
  - **C# + .NET 6**：原生 Windows 支持，性能优异，启动速度快
  - **Self-contained 发布**：打包 .NET 运行时，用户无需安装任何依赖，双击即用
  - **WinForms/WPF**：成熟的 Windows GUI 框架，开发效率高，界面美观
  - **InTheHand.BluetoothLE**：成熟的 BLE 库，支持 Windows 10+ UWP 蓝牙 API
  - **PaddleOCR-Sharp**：离线方案，中文识别准确率高（优于 Tesseract），适合医院内网环境
  - **打包体积**：~120MB（.NET Runtime ~70MB + PaddleOCR 模型 ~50MB），比 Python 方案更小且启动更快

#### 关键组件
1. **BluetoothManager**（C# 类）：负责 BLE 设备扫描、连接、通知订阅（使用 `InTheHand.BluetoothLE`）
2. **HidInputListener**（C# 类）：负责 HID 键盘监听（使用 Windows Raw Input API）
3. **OcrService**（C# 类）：负责屏幕截图、区域定位、PaddleOCR 识别
4. **ApiClient**（C# 类）：负责 HTTP 请求（验证接口、绑定接口，使用 `HttpClient`）
5. **ConfigManager**（C# 类）：负责配置文件读写（使用 `System.Text.Json`）
6. **MainForm**（WinForms）或 **MainWindow**（WPF）：主界面（TabControl 实现四个标签页 + 日志窗口）
7. **FloatingBallForm**（WinForms）：浮球输入窗口（TopMost 窗体）
8. **AutoStartupManager**（C# 类）：开机自启动管理（注册表操作，使用 `Microsoft.Win32.Registry`）

#### 数据存储
- **配置文件**：`app_settings.json`
  ```json
  {
    "bluetooth": {
      "last_device": "25:74:3D:8B:88:39",
      "hid_keywords": "RFID;CARD",
      "card_length": 10,
      "require_enter": true
    },
    "ocr": {
      "fields": [
        {
          "name": "姓名",
          "param": "patientName",
          "enabled": true,
          "region": {"x": 100, "y": 200, "width": 150, "height": 30},
          "default": "",
          "example": "张三"
        }
      ]
    },
    "service": {
      "version": "V2.0",
      "v1": {
        "verify_url": "http://...",
        "bind_url": "http://..."
      },
      "v2": {
        "verify_url": "http://10.10.5.116:62102/api/diagnosis/lk-application/getSingleApplicationDetail/{card_number}",
        "bind_url": "http://10.10.5.116:62102/api/diagnosis/lk-application/bindSingleDiagnosis"
      },
      "enable_verify": true,
      "show_result_popup": true
    },
    "background": {
      "submit_mode": "auto",
      "countdown": 5,
      "auto_start": true,
      "enable_floating_ball": true,
      "enable_service": true
    }
  }
  ```

- **日志文件**：`logs/app.log`（按日期滚动，保留最近 7 天）

#### 接口设计

##### 1. V2 系统 - 洗消验证接口
- **HTTP 方法**：GET
- **URL 格式**：`http://{host}:{port}/api/diagnosis/lk-application/getSingleApplicationDetail/{card_number}`
- **请求参数**：
  - `card_number`：处理后的卡号（10 位数卡号删除前 4 个 0，保留后 6 位）
  - 示例：原始卡号 `0000123456` → 处理后 `123456`
- **响应格式**：
  - 成功：HTTP 200 + JSON 数据或文本消息
  - 失败：HTTP 非 200 或超时（10 秒）
- **成功判断标准**：
  - HTTP 状态码 = 200
  - 响应内容可解析为 JSON 或包含成功消息

##### 2. V2 系统 - 信息绑定接口
- **HTTP 方法**：POST
- **URL 格式**：`http://{host}:{port}/api/diagnosis/lk-application/bindSingleDiagnosis`
- **请求参数**（JSON Body）：
  ```json
  {
    "fields": {
      "cardId": "123456",
      "patientName": "张三",
      "age": "23",
      "gender": "男",
      "department": "外科",
      "...": "..."
    },
    "endoscopeId": "可选",
    "taskId": "可选"
  }
  ```
- **响应格式**：
  - 成功：HTTP 200 + JSON 数据或文本消息
  - 失败：HTTP 非 200 或超时（10 秒）
- **成功判断标准**：
  - HTTP 状态码 = 200
  - 响应内容可解析为 JSON 或包含成功消息

##### 3. V1 系统接口
- **URL 格式**：`http://{host}:{port}/api/path?card_hex={value}&card_dec={value}&{other_fields}`
- **请求参数**：
  - `card_hex`：卡号的十六进制表示
  - `card_dec`：卡号的十进制表示
  - 其他字段：从 OCR 识别或手动输入（动态）
- **响应格式**：同 V2
- **注**：V1 系统的具体接口规范待医院方提供详细文档

### 约束条件

#### 性能要求
- 蓝牙扫描响应时间：≤ 30 秒
- 设备连接时间：≤ 10 秒
- OCR 识别时间：≤ 3 秒（单个字段）
- 接口调用超时：10 秒
- 日志文件大小：单文件 ≤ 10MB，保留最近 7 天

#### 兼容性
- 操作系统：Windows 10 及以上（推荐 Windows 10 1809+，支持 UWP 蓝牙 API）
- .NET 版本：.NET 6（Self-contained 模式，用户无需安装）
- 蓝牙适配器：支持 BLE 4.0+
- 屏幕分辨率：≥ 1280x720

#### 安全性
- 配置文件权限：仅当前用户可读写
- 日志脱敏：不记录完整卡号（仅记录后 4 位）
- 接口通信：支持 HTTPS（如医院要求）
- 数据本地化：所有数据仅存储在本地，不上传云端

#### 可扩展性
- 支持新增 OCR 字段（无代码修改）
- 支持新增系统版本（V3.0、V4.0 等）
- 支持多语言（预留国际化接口）
- 支持插件机制（预留扩展点）

### 风险评估

#### 技术风险
| 风险项 | 影响 | 概率 | 缓解措施 |
|--------|------|------|----------|
| PaddleOCR-Sharp 识别准确率不足 | 高 | 低 | 1. 提供手动修正功能<br>2. 支持默认值回退<br>3. 可切换其他 OCR 引擎（Tesseract.Net） |
| 蓝牙设备兼容性问题 | 高 | 中 | 1. 支持 HID 键盘模式<br>2. 提供浮球手动输入<br>3. 详细日志排查 |
| Windows 权限限制 | 中 | 低 | 1. 提示用户以管理员身份运行<br>2. 降级功能（如自启动失败时提示） |
| .NET 6 Self-contained 打包体积 | 低 | 高 | 1. 使用 PublishTrimmed 裁剪<br>2. 排除不必要的依赖<br>3. 单文件模式（~120MB 可接受） |

#### 依赖风险
| 依赖项 | 风险 | 替代方案 |
|--------|------|----------|
| InTheHand.BluetoothLE | 版本更新可能导致 API 变化 | 锁定版本号（如 `InTheHand.BluetoothLE 4.0.x`） |
| PaddleOCR-Sharp | 模型文件较大（~50MB） | 1. 预下载模型文件<br>2. 提供离线安装包 |
| Windows UWP 蓝牙 API | 系统更新可能影响蓝牙功能 | 1. 测试多个 Windows 版本<br>2. 提供兼容性说明 |

#### 进度风险
| 风险项 | 影响 | 缓解措施 |
|--------|------|----------|
| 医院接口文档不完整 | 延期 | 1. 提前与医院 IT 部门对接<br>2. 提供接口 Mock 工具<br>3. 分阶段交付（先 V2 后 V1） |
| 现场测试环境受限 | 延期 | 1. 提供远程调试工具<br>2. 详细日志记录<br>3. 模拟测试环境 |

---

## 验收标准

### 功能验收
- [ ] **蓝牙配置页**
  - [ ] 能够扫描并列出附近 BLE 设备（设备名、MAC、状态）
  - [ ] 能够连接选中的设备并自动订阅通知
  - [ ] 能够接收并显示蓝牙刷卡器发送的 10 位卡号
  - [ ] 连接失败时自动重连 3 次（间隔 10 秒）
  - [ ] 监听中断开时弹窗提示用户

- [ ] **OCR 配置页**
  - [ ] 能够新增/编辑/删除 OCR 字段
  - [ ] 能够定位屏幕区域（x, y, width, height）
  - [ ] 能够使用 EasyOCR 识别指定区域文本
  - [ ] 识别完成后弹窗显示结果，允许手动修正
  - [ ] 支持启用/禁用字段、填写默认值

- [ ] **服务配置页**
  - [ ] 能够切换 V1.0/V2.0 系统版本
  - [ ] 能够填写并保存验证接口和绑定接口 URL
  - [ ] 能够开启/关闭洗消验证功能
  - [ ] 能够开启/关闭结果弹窗显示

- [ ] **后台配置页**
  - [ ] 能够选择手动/自动提交模式
  - [ ] 自动模式支持 1-30 秒倒计时
  - [ ] 能够开启/关闭开机自启动（写入注册表）
  - [ ] 能够开启/关闭浮球手动输入
  - [ ] 能够开启/关闭后台服务

- [ ] **HID 键盘监听**
  - [ ] 能够配置 HID 设备关键字并扫描设备
  - [ ] 能够监听指定 HID 设备的键盘输入
  - [ ] 能够接收 10 位卡号并触发后续流程
  - [ ] 非 10 位数据自动丢弃
  - [ ] 设备拔出时弹窗提示

- [ ] **业务流程联动**
  - [ ] 刷卡后自动调用验证接口（如已开启）
  - [ ] 验证通过后自动触发 OCR 识别
  - [ ] OCR 完成后弹窗显示所有字段（可修正）
  - [ ] 提交时调用绑定接口
  - [ ] 验证失败时弹窗提示，不再继续
  - [ ] 绑定失败时弹窗提示 + 重试按钮

### 质量标准
- [ ] **代码质量**
  - [ ] 代码符合 C# 编码规范（遵循 Microsoft C# Coding Conventions）
  - [ ] 关键模块有单元测试（覆盖率 ≥ 60%，使用 xUnit 或 NUnit）
  - [ ] 代码审查通过（无严重缺陷）

- [ ] **测试覆盖**
  - [ ] 单元测试：核心模块（BluetoothManager, OcrService, ApiClient）
  - [ ] 集成测试：蓝牙连接 → OCR 识别 → 接口调用完整流程
  - [ ] 兼容性测试：Windows 10/11 多版本测试
  - [ ] 压力测试：连续刷卡 100 次无崩溃

- [ ] **性能指标**
  - [ ] 蓝牙扫描响应时间 ≤ 30 秒
  - [ ] 设备连接时间 ≤ 10 秒
  - [ ] OCR 识别时间 ≤ 3 秒/字段
  - [ ] 接口调用超时 10 秒
  - [ ] 内存占用 ≤ 200MB（运行时）

- [ ] **安全审查**
  - [ ] 配置文件权限正确（仅当前用户可读写）
  - [ ] 日志脱敏（不记录完整卡号）
  - [ ] 无硬编码密钥或敏感信息
  - [ ] 支持 HTTPS 接口调用

### 用户验收
- [ ] **用户体验**
  - [ ] 界面布局清晰，操作流程符合用户习惯
  - [ ] 错误提示友好，提供明确的解决建议
  - [ ] 日志信息详细，便于排查问题
  - [ ] 响应速度快，无明显卡顿

- [ ] **文档交付**
  - [ ] 用户手册（包含安装、配置、使用、故障排查）
  - [ ] 开发文档（架构设计、接口说明、扩展指南）
  - [ ] 部署文档（打包流程、依赖说明、环境要求）

- [ ] **培训材料**
  - [ ] 操作视频（5-10 分钟）
  - [ ] 常见问题 FAQ
  - [ ] 现场培训（如需要）

---

## 执行阶段

### 阶段 1：环境准备与技术验证
**目标**：搭建开发环境，验证关键技术可行性

**任务清单**：
- [ ] 安装 Visual Studio 2022（或 Visual Studio Code + .NET 6 SDK）
- [ ] 创建 WinForms 或 WPF 项目（.NET 6）
- [ ] 安装 NuGet 包：`InTheHand.BluetoothLE`、`PaddleOCR-Sharp`、`System.Text.Json`
- [ ] 验证 PaddleOCR-Sharp 离线识别效果（中文 + 数字）
- [ ] 验证 InTheHand.BluetoothLE 在 Windows 下的 BLE 扫描和连接
- [ ] 验证 Windows Raw Input API 监听 HID 键盘（P/Invoke 调用）
- [ ] 搭建 Mock 接口服务（用于本地测试，可使用 ASP.NET Core Minimal API）

**交付物**：
- 开发环境配置文档
- 技术验证报告（PaddleOCR 准确率测试、蓝牙兼容性测试）

**预计时间**：3-5 天

---

### 阶段 2：核心功能开发
**目标**：实现蓝牙连接、OCR 识别、接口调用等核心模块

**任务清单**：
- [ ] 实现 `BluetoothManager` 类：扫描、连接、通知订阅（使用 InTheHand.BluetoothLE）
- [ ] 实现 `HidInputListener` 类：Raw Input 监听、卡号解析（P/Invoke WinAPI）
- [ ] 实现 `OcrService` 类：屏幕截图、区域定位、PaddleOCR 识别
- [ ] 实现 `ApiClient` 类：HTTP 请求封装（验证接口、绑定接口，使用 HttpClient）
- [ ] 实现 `ConfigManager` 类：JSON 配置文件读写（使用 System.Text.Json）
- [ ] 实现主界面框架（TabControl 实现四个标签页 + RichTextBox 日志窗口）
- [ ] 实现蓝牙配置页（扫描、连接、断开、日志显示）
- [ ] 实现 OCR 配置页（字段管理、区域定位、识别测试）
- [ ] 实现服务配置页（系统版本切换、URL 配置）
- [ ] 实现后台配置页（提交模式、自启动、浮球输入）

**交付物**：
- 核心模块代码（带单元测试，使用 xUnit 或 NUnit）
- 主界面原型（可运行的 WinForms/WPF 应用）

**预计时间**：10-15 天

---

### 阶段 3：业务流程集成与测试
**目标**：串联完整业务流程，进行集成测试和优化

**任务清单**：
- [ ] 实现业务流程联动：刷卡 → 验证 → OCR → 绑定
- [ ] 实现异常处理逻辑（蓝牙断连、OCR 失败、接口超时）
- [ ] 实现弹窗提示（验证失败、绑定失败、手动修正）
- [ ] 实现浮球手动输入功能
- [ ] 实现开机自启动（注册表操作）
- [ ] 实现自动提交倒计时
- [ ] 集成测试：完整流程测试（BLE 模式 + HID 模式）
- [ ] 兼容性测试：Windows 10/11 多版本测试
- [ ] 压力测试：连续刷卡 100 次
- [ ] 性能优化：OCR 识别速度、内存占用

**交付物**：
- 完整功能代码
- 集成测试报告
- 性能测试报告

**预计时间**：7-10 天

---

### 阶段 4：打包部署与文档交付
**目标**：打包为 EXE，编写文档，准备交付

**任务清单**：
- [ ] 使用 .NET 6 Self-contained 模式发布单文件 EXE
  ```bash
  dotnet publish -c Release -r win-x64 --self-contained true /p:PublishSingleFile=true /p:PublishTrimmed=true
  ```
- [ ] 优化打包体积（PublishTrimmed 裁剪、排除不必要依赖）
- [ ] 测试 EXE 在干净 Windows 环境下的运行（无需安装 .NET）
- [ ] 编写用户手册（安装、配置、使用、故障排查）
- [ ] 编写开发文档（架构设计、接口说明、扩展指南）
- [ ] 编写部署文档（打包流程、依赖说明、环境要求）
- [ ] 录制操作视频（5-10 分钟）
- [ ] 整理常见问题 FAQ
- [ ] 准备现场培训材料（如需要）

**交付物**：
- BluetoothCardReaderTool.exe（单文件可执行程序，~120MB）
- 完整文档包（用户手册、开发文档、部署文档）
- 操作视频 + FAQ

**预计时间**：3-5 天

---

**总预计时间**：23-35 天（约 1-1.5 个月）

---

## 文档元数据

**文档版本**：1.0
**创建时间**：2026-01-28
**澄清轮次**：3 轮
**质量评分**：95/100

**澄清记录**：
1. **第一轮**：OCR 技术选型 → 确认使用 **EasyOCR**（离线、准确率高）
2. **第二轮**：接口规范 → 确认 V2 系统接口格式（GET 验证 + POST 绑定）
3. **第三轮**：异常处理策略 → 确认蓝牙重连、OCR 修正、接口重试逻辑
4. **第四轮**：技术栈调整 → 从 Python 改为 **C# + .NET 6 Self-contained + PaddleOCR-Sharp**（免安装、体积更小、启动更快）

**待确认事项**：
- V1.0 系统的详细接口规范（待医院方提供文档）
- PaddleOCR-Sharp 模型文件的离线部署方案（是否需要预下载）
- 医院现场测试环境的网络配置（是否支持 HTTPS）

---

**文档状态**：✅ 已完成，可进入开发阶段
