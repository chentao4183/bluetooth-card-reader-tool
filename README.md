## 蓝牙小工具（Windows）

一个基于 Python 的 Windows 小工具，用于扫描本机 BLE 蓝牙设备、连接并订阅通知，实时展示设备发送的数据。

### 功能
- 扫描附近的 BLE 设备
- 选择设备并连接
- 自动发现可通知(Notify)特征并订阅
- 实时显示来自设备的通知数据（以 HEX 与可打印 ASCII）

### 界面原型（蓝牙配置页）
- 顶部提供 `蓝牙配置`、`OCR配置`、`服务配置`、`后台配置` 四个标签页，当前原型主要展示蓝牙配置主界面。
- 左侧 `扫描` 按钮触发 BLE 扫描，结果以表格形式列出，包含 `设备名称`、`MAC 地址`、`状态` 三列，方便区分 `空`、`已配对`、`已连接` 等状态。
- 右侧提供 `连接`、`断开` 按钮，并在“已连接并监听的蓝牙设备”区域展示当前监听设备及其 MAC，便于确认目标设备（如“蓝牙刷卡器1 | 25:74:3D:8B:88:39”）。
- 下方“日志打印”窗口滚动展示扫描、连接、监听过程日志，以及蓝牙刷卡器上报的数据，便于排查与验证。
- 底部操作提示引导用户依次执行：1) 点击扫描 2) 在列表中选择设备并连接 3) 通过日志观察监听结果与刷卡数据。

### 界面原型（OCR配置页）
- 表格列出所有可映射的字段，包含 `名称`、`参数名`、`默认`、`识图`、`识别示例`、`操作` 六列，并提供复选框用于启用/禁用字段。
- `新增` 按钮可扩展新字段；`默认` 列展示静态默认值，适用于无法通过 OCR 获得、需要手动切换的多选项字段（用分号分隔）。
- `识图` 区域表示屏幕上需定位的 OCR 范围；点击每行的 `定位` 按钮进入截图/选区流程，`识别` 触发 OCR，`删除` 移除该字段。
- `识别示例` 显示最近一次识别结果，便于确认提取是否正确，如“张三”“23”“男”等。
- 底部 tips 说明字段来源：① 工具内置参数（如卡ID/诊疗时间）由设备交互获得；② OCR 识别字段需先完成屏幕定位；③ 默认配置字段在 OCR 结果缺失时提供回退值。
- 额外说明 OCR 完成后会汇总所有参数，按默认配置里的顺序显示，支持通过下拉框或手动切换备选项。

### 界面原型（服务配置页）
- 提供“对接系统选择”区块，可在 V1.0/V2.0 两套后端接口之间切换；每个版本包含“洗消验证接口”“信息绑定接口”两个 URL 输入框，默认示例为内网地址，可根据医院部署环境调整。
- “验证功能选择”区块允许开启/关闭洗消结果验证；当开启时，可继续勾选“弹窗显示洗消成功/失败结果”以决定刷卡后弹窗提示逻辑。
- 文本说明强调工具需兼容新旧系统：若验证接口返回通过，工具会携带蓝牙卡号与 OCR 识别参数提交到信息绑定接口；验证失败则提示人工复查。
- 关闭验证功能时仅保留绑定逻辑，不再弹窗提示；适合只需记录绑定信息的场景。

### 界面原型（后台配置页）
- “信息绑定弹窗”提供 `手动提交` 与 `自动提交` 两种模式；自动模式可设置倒计时（如 5 秒）后自动提交并关闭弹窗，适合流水线式刷卡。
- 复选项包含：`开机自启动`（登录后自动在后台运行，无需人工开启）、`开启浮球输入`（当蓝牙刷卡器不可用时，通过屏幕浮球手动输入卡号以继续 OCR 流程）、`开启服务`（启动后台常驻服务以串联上述功能）。
- 底部说明进一步解释：字段齐备时既可手动提交也可自动提交；开机自启动适合医生电脑日常全天运转；浮球输入是刷卡硬件异常时的应急手段；开启服务后系统会持续运行相关能力。

### 业务流程图
- 流程起点：插入蓝牙刷卡器、完成 BLE 连接并读取卡号/G 广告信息；若设备未连接则提示排查。
- 若启用洗消验证功能，判断要对接 V1.0 还是 V2.0 接口；针对不同版本分别调用洗消验证与信息绑定接口，并根据返回结果决定是否继续。
- 当洗消验证通过且 OCR 所需字段齐备时，启动 OCR 截图识别，组合蓝牙卡号、OCR 数据与默认字段，准备提交。
- 验证失败、OCR 缺失或绑定接口异常时，会弹出提示并可手动重试；若开启自动提交，会在倒计时结束后自动发送绑定请求并关闭弹窗。
- 业务闭环：洗消成功 → 绑定成功 → 结果提示完成；洗消失败或绑定失败 → 结果提示异常并停止流程。

### 新增功能概览
- **多标签页 UI**：主界面新增 `ttk.Notebook`，蓝牙配置、OCR 配置、服务配置、后台配置互不干扰，配合底部日志窗口统一查看运行轨迹。
- **配置持久化**：所有字段、接口、后台策略保存在 `app_settings.json`，首次运行自动生成，可随时导出保存。
- **OCR 字段管理**：支持新增/编辑/启用/禁用字段，手动录入识别结果，记录默认值与示例；可填写识别区域 `x,y,width,height` 为后续自动 OCR 做准备。
- **服务接口管理**：同时维护 V1/V2 两套接口地址，任选其一驱动洗消验证与信息绑定；可分别控制验证开关以及成功/失败弹窗策略。
- **后台自动化**：可选择手动或自动提交绑定弹窗，自动模式支持 1~30 秒倒计时；可开启 Windows 登录自启动、浮球手动输入卡号、整套自动服务流程。
- **业务流程联动**：当蓝牙刷卡器监听到卡号时，工具会按配置自动执行验证、弹窗、提交并打印日志，浮球输入也可触发同样流程。

### HID 键盘模式监听
- 某些蓝牙刷卡器以 HID 键盘方式工作，不提供 BLE GATT 通知。本工具新增 Raw Input 监听能力，可在后台捕获指定设备的键盘输入（即 10 位卡号）。
- 在“后台配置”中设置“HID 监听配置”：勾选启用、填写设备关键字（例如 `RFID;CARD`，与系统设备名称部分匹配即可）、配置卡号长度及是否必须 `Enter` 结束。
- Windows 需保持该 HID 设备已在系统里添加/配对；工具无需再通过 BLE 连接即可获取刷卡卡号，并继续执行洗消验证、绑定等逻辑。
- 若键盘模式设备异常，可切换到浮球手动输入或继续沿用 BLE 模式（若硬件另行支持）。
- “扫描”按钮现在调用 Windows 设备枚举接口，展示当前机器已配对/已连接的蓝牙设备（含 HID 键盘）。选中目标后点击“连接”即可锁定对应的 HID 输入，其它键盘将被忽略。

### 环境要求
- Windows 10 及以上
- Python 3.9+（建议 3.10/3.11）
- 蓝牙适配器驱动正常工作

### 安装
```bash
python -m venv .venv
.\.venv\Scripts\activate
pip install -r requirements.txt
```

### 运行
```bash
python -m app
```

首启步骤：
1. 点击“扫描”按钮，等待附近设备列表出现。
2. 选中目标设备，点击“连接”。
3. 成功连接后程序会自动发现服务并订阅所有支持 Notify 的特征，通知数据会在日志中滚动显示。

如遇 `ImportError: No module named 'app'`，请确保在项目根目录 `bloothcard/` 外层运行命令，或切换到包含 `app` 目录的同级目录执行：
```bash
cd bloothcard
python -m app
```

### 注意事项
- 本工具使用 `bleak`（基于 WinRT）访问 BLE。对于经典蓝牙（非BLE）暂不支持。
- 某些设备未开放 Notify 特征或需特定配对流程，可能无法接收数据。
- 如果设备有多个 Notify 特征，程序会尝试订阅全部；你可在日志中观察具体特征 UUID。

### 常见问题
- 无法扫描到设备：确认设备已上电且处于可被发现状态；确保 Windows 蓝牙已开启。
- 连接失败：尝试在 Windows 设置中移除已配对记录后重试；靠近设备；重启蓝牙适配器。
- 无数据：设备可能不通过 Notify 发送，或需要写入指令以触发。后续可扩展写入功能。

### 进阶
- 若需要订阅特定特征，可在 `app/ble/ble_manager.py` 中 `_discover_and_subscribe` 里筛选相应 UUID。
- 若需要写入数据触发上报，可在 `BleManager` 中添加 `write_gatt_char(uuid, data)` 方法并在界面增加按钮。

### 目录结构
```
bloothcard/
  app/
    __init__.py
    __main__.py
    main.py
    ble/
      __init__.py
      ble_manager.py
  requirements.txt
  requirements-build.txt
  scripts/
    build_exe.ps1
  README.md
```

### 打包为 EXE（Windows）
1. 进入目录并启用虚拟环境
```powershell
cd F:\trae\bloothcard\bloothcard
python -m venv .venv
.\.venv\Scripts\activate
pip install -r requirements.txt
```
2. 安装构建依赖并打包
```powershell
pip install -r requirements-build.txt
powershell -ExecutionPolicy Bypass -File .\scripts\build_exe.ps1
```
3. 可执行文件位置
```
dist\BLEBlueTool.exe
```
4. 常见打包问题
- 首次运行较慢：单文件模式会自解压到临时目录，属正常现象。
- 找不到蓝牙模块：已在脚本中通过 `--hidden-import` 包含 WinRT 相关模块；若仍失败，请升级 `pyinstaller` 与 `bleak`。

### 许可证
MIT


